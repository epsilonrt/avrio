<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>AvrIO: idwarf/terminal/hub/terminal_hub.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="avrio.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">AvrIO
   &#160;<span id="projectnumber">0.34-dev</span>
   </div>
   <div id="projectbrief">Bibliothèque C modulaire pour ATMEL AVR</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Généré par Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Recherche');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Page&#160;principale</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Structures&#160;de&#160;données</span></a></li>
      <li><a href="examples.html"><span>Exemples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Recherche" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('a00046.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>Tout</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Structures de données</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Fonctions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Définitions de type</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Énumérations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Valeurs énumérées</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groupes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">idwarf/terminal/hub/terminal_hub.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>Exemple complet qui affiche sur la liaison série les informations reçues des capteurs qui intégre des commandes permettant de gérer l'intégration et l'exclusion des capteurs et de leur envoyer des informations.</p>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;avrio/serial.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;avrio/term.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;avrio/util.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;avrio/led.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;idwarf/hub.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="comment">/* constants ================================================================ */</span></div>
<div class="line"><span class="preprocessor">#define DEBUG_BAUDRATE 115200</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ADC_SCALE 3.3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define CMD_SIZE 21</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define BEACON_TIME IDWARF_SLEEP_TIME(5) // 5 sec.</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">/* public variables ========================================================= */</span></div>
<div class="line"><span class="comment">// buffered data, received from the sensor</span></div>
<div class="line">uint8_t ucData[<a name="a0"></a><a class="code" href="a00292.html#ga25ba9e21a6c1edc58a705f9fb8411ede">IDWARF_PAYLOAD_SIZE</a>];</div>
<div class="line">uint8_t ucDataLen = 0;</div>
<div class="line">uint16_t usBeaconTime = BEACON_TIME;</div>
<div class="line"></div>
<div class="line"><span class="comment">// global flag for hex mode</span></div>
<div class="line"><span class="keyword">enum</span> {</div>
<div class="line">  HEX_FLAG = 0x01,</div>
<div class="line">  PRINT_FLAG = 0x02</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keyword">volatile</span> uint8_t ucFlags = HEX_FLAG | PRINT_FLAG;</div>
<div class="line"></div>
<div class="line"><span class="comment">/* internal public functions ================================================ */</span></div>
<div class="line"><span class="keywordtype">void</span> vSensorPacketReceived (<a class="code" href="a00292.html#ga3ac2f53a6db3f2414db8091758ad890f">PACKET_TYPES</a>, uint16_t, uint8_t, <span class="keyword">volatile</span> uint8_t *);</div>
<div class="line"><span class="keywordtype">void</span> vProcessRxData (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> vPrintStatus (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> vPrintOk (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> vPrintBeaconTime (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> vPrintHelp (<span class="keywordtype">void</span>);</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// Le programme principal</span></div>
<div class="line"><span class="keywordtype">int</span> </div>
<div class="line">main (<span class="keywordtype">void</span>) {</div>
<div class="line"></div>
<div class="line">  <a name="a1"></a><a class="code" href="a00255.html#ga402ecada09e3d308af22f3b85f0033ef">vLedInit</a>();</div>
<div class="line">  <a name="a2"></a><a class="code" href="a00268.html#ga770100af2274a610a599bcd2ca6c3151">vSerialInit</a> (DEBUG_BAUDRATE / 100, <a name="a3"></a><a class="code" href="a00268.html#ga28fcce07fff5b8915fed8df46864ad5f">SERIAL_DEFAULT</a> + <a name="a4"></a><a class="code" href="a00268.html#ga86d1b8c4be37e64ed7a2416c3f5811d0">SERIAL_RW</a>);</div>
<div class="line">  stdout = &amp;<a name="a5"></a><a class="code" href="a00268.html#gad4433689a8864aba726dc2845566a73b">xSerialPort</a>;</div>
<div class="line"></div>
<div class="line">  printf_P (PSTR(<span class="stringliteral">&quot;\r\riDwaRF - Firmware v&quot;</span> __IDWARF_VERSION_STRING__ <span class="stringliteral">&quot; Hub version\n\n&quot;</span>));</div>
<div class="line"></div>
<div class="line">  <span class="comment">// initialise le firmware iDwaRF</span></div>
<div class="line">  printf_P(PSTR(<span class="stringliteral">&quot;Init... &quot;</span>));</div>
<div class="line">  <a name="a6"></a><a class="code" href="a00292.html#gabafd325193df7d07f2c94b40ae7c9724">rfInit</a>(); <span class="comment">// les interruptions sont validées...</span></div>
<div class="line">  vPrintOk();</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Enregistre les fonctions de traitement de l&#39;utilisateur </span></div>
<div class="line">  printf_P(PSTR(<span class="stringliteral">&quot;Register Call Back functions... &quot;</span>));</div>
<div class="line">  <a name="a7"></a><a class="code" href="a00293.html#ga5c28f5f58329f36ede84c1b3a94d9eed">rfRegisterCBSensorDataReceived</a> (vSensorPacketReceived);</div>
<div class="line">  vPrintOk();</div>
<div class="line"></div>
<div class="line">  vPrintStatus();</div>
<div class="line">  vPrintBeaconTime();</div>
<div class="line">  vPrintHelp();</div>
<div class="line">  puts_P(PSTR(<span class="stringliteral">&quot;\nProcess All ...&quot;</span>));</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// la boucle principale gère les événements du réseau...</span></div>
<div class="line">    <a name="a8"></a><a class="code" href="a00292.html#ga284181d3fe49a8f027874bb287387a03">rfProcessAll</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// if the serial callback has set this flag, there is new data to be processed.</span></div>
<div class="line">    <span class="comment">//  done here to prevent overload in the callback function</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a9"></a><a class="code" href="a00268.html#ga3fb954eb067ce9d7ca5f39671ae7d30d">usSerialHit</a>()) {</div>
<div class="line">    </div>
<div class="line">      vProcessRxData();</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// show the saved data received with the last sensor packet </span></div>
<div class="line">    <span class="comment">//  OutStr takes some time - that&#39;s the reason why it is done here!</span></div>
<div class="line">    <span class="comment">//  ucData holds the data and ucDataLen is the amount of data stored in ucData.</span></div>
<div class="line">    <span class="keywordflow">if</span> (ucDataLen &gt; 0) {</div>
<div class="line">      uint8_t * pucData = ucData;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">if</span> ((ucFlags &amp; HEX_FLAG) == 0) {  <span class="comment">// show data user friendly</span></div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ucDataLen &gt;= 1) {</div>
<div class="line"> </div>
<div class="line">          <span class="comment">// Push Button state - 1 byte</span></div>
<div class="line">          printf_P (PSTR(<span class="stringliteral">&quot;Button %s&quot;</span>), (*pucData++ != 0 ? <span class="stringliteral">&quot;ON &quot;</span> : <span class="stringliteral">&quot;off&quot;</span>));</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (ucDataLen &gt;= 2) {</div>
<div class="line">          uint8_t ucBatt;</div>
<div class="line">          </div>
<div class="line">          <span class="comment">// Battery voltage - 1 byte</span></div>
<div class="line">          ucBatt = *pucData++;</div>
<div class="line">          printf_P (PSTR(<span class="stringliteral">&quot; Batt &lt;0x%02X&gt; %.2fV&quot;</span>), ucBatt, ADC_SCALE * (<span class="keywordtype">float</span>) ucBatt / 256.0);</div>
<div class="line">        </div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (ucDataLen &gt;= 4) {</div>
<div class="line">          int16_t iTemp;</div>
<div class="line">          </div>
<div class="line">          <span class="comment">// Temperature value - 2 bytes</span></div>
<div class="line">          iTemp   = (*pucData++) &lt;&lt; 8;</div>
<div class="line">          iTemp  +=  *pucData++;</div>
<div class="line">          printf_P (PSTR(<span class="stringliteral">&quot; Temp (0x%02X) %.1fḞC&quot;</span>), iTemp, (<span class="keywordtype">float</span>)iTemp / 10.0);</div>
<div class="line">       </div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (ucDataLen &gt;= 5) {</div>
<div class="line">        </div>
<div class="line">          <span class="comment">// Light Dependent Resistor value - 1 byte</span></div>
<div class="line">          printf_P (PSTR(<span class="stringliteral">&quot; Ldr %d&quot;</span>), *pucData++);</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      </div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">while</span> (pucData &lt; (ucData + ucDataLen)) {</div>
<div class="line">      </div>
<div class="line">        printf_P (PSTR(<span class="stringliteral">&quot;%02X &quot;</span>), *pucData++);</div>
<div class="line">      }</div>
<div class="line"></div>
<div class="line">      <span class="comment">// show the payload size</span></div>
<div class="line">      printf_P (PSTR(<span class="stringliteral">&quot;&gt; len=%d\n&quot;</span>), ucDataLen);</div>
<div class="line">      ucDataLen = 0;  <span class="comment">// reset. Otherwise this data is displayed non stop.</span></div>
<div class="line">    }    </div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">/* internal public functions ================================================ */</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> vPrintOk (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> vPrintError (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> vEnumerateAllSensors (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> vCleanupSensorList (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> vDoTimCommand (<span class="keywordtype">char</span> * cCmd, uint8_t ucLen);</div>
<div class="line"><span class="keywordtype">void</span> vDoCnfCommand (<span class="keywordtype">char</span> * cCmd, uint8_t ucLen);</div>
<div class="line"><span class="keywordtype">void</span> vDoSndCommand (<span class="keywordtype">char</span> * cCmd, uint8_t ucLen);</div>
<div class="line"><span class="keywordtype">void</span> vDoDelCommand (<span class="keywordtype">char</span> * cCmd, uint8_t ucLen);</div>
<div class="line"><span class="keywordtype">void</span> vSendBackData (uint16_t usDeviceId, uint8_t * pucPayload, uint8_t ucPayloadLen);</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// vSensorPacketReceived (callback)</span></div>
<div class="line"><span class="comment">//  xPacketType     - Type de paquet reçu: BIND_REQUEST or fixed/variable data packets</span></div>
<div class="line"><span class="comment">//  usDeviceId      - Identifiant du capteur qui a envoyé le paquet</span></div>
<div class="line"><span class="comment">//  ucUserDataCount - nombre d&#39;octets de payload stockés dans pucBuffer</span></div>
<div class="line"><span class="comment">//  pucData         - Pointeur sur les données transmises. Seuls les ucUserDataCount octets sont valides.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> vSensorPacketReceived (<a class="code" href="a00292.html#ga3ac2f53a6db3f2414db8091758ad890f">PACKET_TYPES</a> xPacketType, uint16_t usDeviceId, </div>
<div class="line">                uint8_t ucUserDataCount, <span class="keyword">volatile</span> uint8_t * pucData) {</div>
<div class="line">                </div>
<div class="line">  <span class="comment">// Un paquet a été reçu venant d&#39;un capteur: Placez votre code ici.</span></div>
<div class="line">  <span class="keyword">static</span> uint8_t ucPacketCount;</div>
<div class="line">  </div>
<div class="line">  <a name="a10"></a><a class="code" href="a00255.html#ga96660ffee52cd8c241a9ea6b1bdf45f4">vLedToggle</a> (<a name="a11"></a><a class="code" href="a00255.html#gae657fbb1817cd0fbe9ccd986ba0d5c74">LED_LED1</a>);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> (ucUserDataCount == 5) {</div>
<div class="line">  </div>
<div class="line">    <span class="keywordflow">if</span> (pucData[4] != 0) {  <span class="comment">// this packet triggers the LED toggle</span></div>
<div class="line"></div>
<div class="line">      <a class="code" href="a00255.html#ga96660ffee52cd8c241a9ea6b1bdf45f4">vLedToggle</a> (LED_LED2);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  ucPacketCount++;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (ucFlags &amp; PRINT_FLAG) {</div>
<div class="line">  </div>
<div class="line">    printf_P (PSTR(<span class="stringliteral">&quot;%03d&gt; S%d-&quot;</span>), ucPacketCount, xPacketType);</div>
<div class="line">    <span class="keywordflow">switch</span> (xPacketType) {</div>
<div class="line">    </div>
<div class="line">      <span class="keywordflow">case</span> BIND_REQUEST_PACKET: <span class="comment">// 0x00</span></div>
<div class="line">        puts_P (PSTR(<span class="stringliteral">&quot;BIND_REQUEST\n&quot;</span>));</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">case</span> <a name="a12"></a><a class="code" href="a00292.html#gga3ac2f53a6db3f2414db8091758ad890faad8c457aafeb99a6622d23b72c4370cd">FIXED_DATA_PACKET</a>: <span class="comment">// 0x04: Data packet of fixed length as defined by SIZE_OF_FIXED_DATA_PACKET</span></div>
<div class="line">        <span class="comment">// no break</span></div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">case</span> <a name="a13"></a><a class="code" href="a00292.html#gga3ac2f53a6db3f2414db8091758ad890fac2411b329ffe928f93dc0030fd3e5af7">VARIABLE_DATA_PACKET</a>: <span class="comment">// 0x05: Data packet of variable length</span></div>
<div class="line">        printf_P (PSTR(<span class="stringliteral">&quot;ID%d &lt;&quot;</span>), usDeviceId);</div>
<div class="line">        <span class="comment">// copy payload to the buffer for later, time intensive processing</span></div>
<div class="line">        <span class="keywordflow">for</span> (uint8_t n = 0; n &lt; ucUserDataCount; n ++) {</div>
<div class="line">          </div>
<div class="line">          ucData[n] = *pucData++;</div>
<div class="line">        }</div>
<div class="line">        ucDataLen = ucUserDataCount;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"></div>
<div class="line">      <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">    </div>
<div class="line">  <span class="comment">// set the backchannel data if there&#39;s storage free</span></div>
<div class="line">  <span class="keywordflow">if</span> (<a name="a14"></a><a class="code" href="a00293.html#gae2bbb0ff4fe7815b1b32a83e4f983176">rfIsBackchannelFree</a> (usDeviceId)) {</div>
<div class="line">  </div>
<div class="line">    <a name="a15"></a><a class="code" href="a00293.html#gaee368d1d10062ee8ef9db75e1364a2fe">rfSetBackchannelData</a> (usDeviceId, 1, usBeaconTime, &amp;ucPacketCount, 1);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// implements the serial protocol of the hub module</span></div>
<div class="line"><span class="comment">// this function is called from the mainloop when data from the usart has</span></div>
<div class="line"><span class="comment">// been received.</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vProcessRxData (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">char</span> cCmd[CMD_SIZE];</div>
<div class="line">  <span class="keyword">static</span> uint8_t ucPos;</div>
<div class="line">  <span class="keyword">static</span> <span class="keywordtype">char</span> cLastChar;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">while</span> (<a class="code" href="a00268.html#ga3fb954eb067ce9d7ca5f39671ae7d30d">usSerialHit</a>() &amp;&amp; (cLastChar != <span class="charliteral">&#39;\r&#39;</span>)) {</div>
<div class="line">  </div>
<div class="line">    cLastChar = cSerialGetChar();</div>
<div class="line">    ucFlags &amp;= ~PRINT_FLAG;</div>
<div class="line">    cCmd[ucPos] = cLastChar;</div>
<div class="line">    <span class="keywordflow">if</span> (ucPos &lt; CMD_SIZE) {</div>
<div class="line">    </div>
<div class="line">      ucPos++;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">    </div>
<div class="line">      ucPos = 0;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">              </div>
<div class="line">  <span class="comment">// check for the end char - \r triggers the command matching</span></div>
<div class="line">  <span class="keywordflow">if</span> (cLastChar == <span class="charliteral">&#39;\r&#39;</span>) {</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;rst\r&quot;</span>), 4) == 0) {</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// RESET</span></div>
<div class="line">      vPrintOk();     <span class="comment">// acknowledge the rs command</span></div>
<div class="line">      <a name="a16"></a><a class="code" href="a00293.html#gad1afc05c39d5aa99a9b7dbe424b83037">rfReset</a>();</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;gps\r&quot;</span>), 4) == 0) {</div>
<div class="line"></div>
<div class="line">      <span class="comment">// GETPROTOCOLSTATUS</span></div>
<div class="line">      vPrintOk();</div>
<div class="line">      vPrintStatus();</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;bon\r&quot;</span>), 4) == 0) {</div>
<div class="line">    </div>
<div class="line">      <span class="comment">// start bind / bind on</span></div>
<div class="line">      vPrintOk();</div>
<div class="line">      <a name="a17"></a><a class="code" href="a00293.html#ga0ed69ac82f8c499c22691bc4bd5357e0">rfStartBind</a>();</div>
<div class="line">      vPrintStatus();</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;bof\r&quot;</span>), 4) == 0) {</div>
<div class="line">    </div>
<div class="line">      <span class="comment">// stop bind / bind off</span></div>
<div class="line">      vPrintOk();</div>
<div class="line">      <a name="a18"></a><a class="code" href="a00293.html#ga489bcc0a1f2c4a48f4c9aa254faa2ab3">rfStopBind</a>();  </div>
<div class="line">      vPrintStatus();</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;enu\r&quot;</span>), 4) == 0) {</div>
<div class="line">      </div>
<div class="line">      <span class="comment">// enumerate all sensors</span></div>
<div class="line">      vPrintOk();</div>
<div class="line">      vEnumerateAllSensors();</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;cln\r&quot;</span>), 4) == 0) {</div>
<div class="line">    </div>
<div class="line">      <span class="comment">// clear up the sensorlist</span></div>
<div class="line">      vPrintOk();</div>
<div class="line">      vCleanupSensorList();</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;hex\r&quot;</span>), 4) == 0) {</div>
<div class="line">      </div>
<div class="line">      <span class="comment">// switch output to hex numbers</span></div>
<div class="line">      vPrintOk();</div>
<div class="line">      ucFlags ^= HEX_FLAG;</div>
<div class="line">      printf_P (PSTR(<span class="stringliteral">&quot;hex %d\r&quot;</span>), ucFlags &amp; HEX_FLAG);</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;hlp\r&quot;</span>), 4) == 0) {</div>
<div class="line"></div>
<div class="line">      <span class="comment">// display help message</span></div>
<div class="line">      vPrintOk();</div>
<div class="line">      vPrintHelp();</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;cnf&quot;</span>), 3) == 0) {</div>
<div class="line">      </div>
<div class="line">      <span class="comment">// configure network parameters</span></div>
<div class="line">      vDoCnfCommand (cCmd, ucPos);</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;tim&quot;</span>), 3) == 0) {</div>
<div class="line">      </div>
<div class="line">      <span class="comment">// configure beacon time</span></div>
<div class="line">      vDoTimCommand (cCmd, ucPos);</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;snd&quot;</span>), 3) == 0) {</div>
<div class="line">      </div>
<div class="line">      <span class="comment">// send backchannel data</span></div>
<div class="line">      vDoSndCommand (cCmd, ucPos);</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strncmp_P (cCmd, PSTR(<span class="stringliteral">&quot;del&quot;</span>), 3) == 0) {</div>
<div class="line">      </div>
<div class="line">      <span class="comment">// remove sensor(s) from the hub</span></div>
<div class="line">      vDoDelCommand (cCmd, ucPos);</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> {  <span class="comment">// unknown command - return error code</span></div>
<div class="line">      </div>
<div class="line">      vPrintError();  <span class="comment">// signal a problem</span></div>
<div class="line">    }</div>
<div class="line">    ucPos = 0;  <span class="comment">// reset the buffer to sync to the input</span></div>
<div class="line">    cLastChar = 0;</div>
<div class="line">    ucFlags |= PRINT_FLAG;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// serial protocol - everything is right</span></div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">vPrintHelp (<span class="keywordtype">void</span>) {</div>
<div class="line"></div>
<div class="line">  puts_P(PSTR(<span class="stringliteral">&quot;\n\nHub commands list:\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;rst\t\t\t\t - Reset firmware\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;gps\t\t\t\t - Get protocol status\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;bon\t\t\t\t - Set Bind On\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;bof\t\t\t\t - Set Bind Off\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;enu\t\t\t\t - Enumarate all sensors\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;cln\t\t\t\t - Cleanup sensor list\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;hex\t\t\t\t - Switch output to hex numbers\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;hlp\t\t\t\t - Display this help\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;cnf PNCODE CHANNEL\t\t - Configure Network parameters\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;tim BEACONTIME\t\t\t - Configure beacon time (unit=125ms)\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;snd DEVICEID BYTE1 [BYTE2]...\t - Send backchannel data\n&quot;</span></div>
<div class="line">                  <span class="stringliteral">&quot;\t\t\t\t   DEVICEID=x playload send to all devices\n&quot;</span></div>
<div class="line">              <span class="stringliteral">&quot;del [DEVICEID]\t\t\t - Remove sensor(s) from the hub\n\n&quot;</span></div>
<div class="line">  ));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// serial protocol - everything is right</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vPrintOk (<span class="keywordtype">void</span>) {</div>
<div class="line"></div>
<div class="line">  puts_P (PSTR(<span class="stringliteral">&quot;Ok&quot;</span>));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// serial protocol - something was wrong. Command not understood</span></div>
<div class="line"><span class="comment">//  or error while performing command.</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vPrintError (<span class="keywordtype">void</span>) {</div>
<div class="line"></div>
<div class="line">  puts_P (PSTR(<span class="stringliteral">&quot;Error&quot;</span>));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vPrintStatus (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint8_t ucStatus;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// GETPROTOCOLSTATUS</span></div>
<div class="line">  ucStatus = <a name="a19"></a><a class="code" href="a00293.html#ga2fd004b962b40628cbfb2d8459fd1c5d">rfGetProtocolStatus</a>();</div>
<div class="line">  printf_P (PSTR(<span class="stringliteral">&quot;Status 0x%02X\n&quot;</span>), ucStatus);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vPrintBeaconTime (<span class="keywordtype">void</span>) {</div>
<div class="line"></div>
<div class="line">  printf_P (PSTR(<span class="stringliteral">&quot;Beacon Time %d s.\n&quot;</span>), usBeaconTime &gt;&gt; 3);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// vEnumerateAllSensors</span></div>
<div class="line"><span class="comment">//  show all Devices/Sensors connected to the hub.</span></div>
<div class="line"><span class="comment">//  go through all possible DeviceIds and query for a valid entry</span></div>
<div class="line"><span class="comment">//  and its MID value. This data is than transfered to the host</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vEnumerateAllSensors (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint16_t usDeviceId;</div>
<div class="line">  uint16_t usNumOfDevicesFound = 0;</div>
<div class="line">  uint16_t usMaximumDeviceId = <a name="a20"></a><a class="code" href="a00293.html#gafca611de2af26b00c78adf47e4460781">rfGetMaximumDeviceId</a>();</div>
<div class="line">  </div>
<div class="line">  printf_P (PSTR(<span class="stringliteral">&quot;Maximum Devices = %d\n&quot;</span>), usMaximumDeviceId);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span> (usDeviceId = 0; usDeviceId &lt;= usMaximumDeviceId; usDeviceId++) {</div>
<div class="line">    <a name="_a21"></a><a class="code" href="a00051.html">MID</a> xMid;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a22"></a><a class="code" href="a00293.html#ga270559d73bc5379a0fe9a7d72b88af98">rfGetSensorMID</a> (usDeviceId, &amp;xMid)) {</div>
<div class="line">    </div>
<div class="line">      <span class="comment">// valid Device found</span></div>
<div class="line">      <a name="a23"></a><a class="code" href="a00200.html#gabc176ef97a890283c72c22a50d6f57ea">vSwapBytes</a> ((uint8_t *) &amp;xMid.<a name="a24"></a><a class="code" href="a00051.html#acb9bc9b68fc307eafbb50d766b162fe4">u32Mid</a>, 4);</div>
<div class="line">      printf_P (PSTR(<span class="stringliteral">&quot;deviceID = %d %+08lX\n&quot;</span>), usDeviceId, xMid.<a class="code" href="a00051.html#acb9bc9b68fc307eafbb50d766b162fe4">u32Mid</a>);</div>
<div class="line">      usNumOfDevicesFound++;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  printf_P (PSTR(<span class="stringliteral">&quot;nofDevices = %d\n&quot;</span>), usNumOfDevicesFound);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// remove duplicated entries out of the bound devices list. If a device/sensor</span></div>
<div class="line"><span class="comment">//  tries to bind multiple time, it gets multiple deviceIds. There is not enough</span></div>
<div class="line"><span class="comment">//  time in the firmware to check for duplicates while bind. So this functions</span></div>
<div class="line"><span class="comment">//  removes them, when called. This can be quite time consuming.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vCleanupSensorList (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint16_t usDeviceId1;</div>
<div class="line">  uint16_t usMaximumDeviceId = <a class="code" href="a00293.html#gafca611de2af26b00c78adf47e4460781">rfGetMaximumDeviceId</a>();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// go through all bound and active sensor nodes</span></div>
<div class="line">  <span class="keywordflow">for</span> (usDeviceId1 = 0; usDeviceId1 &lt;= usMaximumDeviceId; usDeviceId1++) {</div>
<div class="line">    <a class="code" href="a00051.html">MID</a> xMid1;</div>
<div class="line">    uint16_t usDeviceId2;</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="a00293.html#ga270559d73bc5379a0fe9a7d72b88af98">rfGetSensorMID</a> (usDeviceId1, &amp;xMid1)) {</div>
<div class="line">    </div>
<div class="line">      <span class="keywordflow">for</span> (usDeviceId2 = usDeviceId1 + 1; usDeviceId2 &lt;= usMaximumDeviceId; usDeviceId2++) {</div>
<div class="line">        <a class="code" href="a00051.html">MID</a> xMid2;</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="a00293.html#ga270559d73bc5379a0fe9a7d72b88af98">rfGetSensorMID</a> (usDeviceId2, &amp;xMid2)) {</div>
<div class="line">        </div>
<div class="line">          <span class="comment">// check for a duplicate MID entry</span></div>
<div class="line">          <span class="keywordflow">if</span> (memcmp (&amp;xMid1, &amp;xMid2, 4) == 0) {</div>
<div class="line">          </div>
<div class="line">            printf_P (PSTR (<span class="stringliteral">&quot;Same entry found! remove the first one %d\n&quot;</span>), usDeviceId1);</div>
<div class="line">            <a name="a25"></a><a class="code" href="a00293.html#ga94f65ad2454ca5084807877fe5cb0259">rfDeleteSensor</a> (usDeviceId1);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// vSendBackData()</span></div>
<div class="line"><span class="comment">//  deviceID - the id of the sensor, the target of the message</span></div>
<div class="line"><span class="comment">//  pucPayload - pointer to the data that should be send to the sensor</span></div>
<div class="line"><span class="comment">//  ucPayloadLen - amount of data that payload points to. </span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vSendBackData (uint16_t usDeviceId, uint8_t * pucPayload, uint8_t ucPayloadLen) {</div>
<div class="line">  <span class="keyword">static</span> uint8_t ucPktCount = 0;  <span class="comment">// ucPktCount is incremented each time, just for fun + to see it is working</span></div>
<div class="line">  uint8_t ucStatus;</div>
<div class="line">  uint8_t * pucData = pucPayload;</div>
<div class="line">  </div>
<div class="line">  printf_P (PSTR (<span class="stringliteral">&quot;SND-ID%d &lt;%04X %02X&quot;</span>), usDeviceId, usBeaconTime, ucPktCount);</div>
<div class="line">  <span class="keywordflow">while</span> (pucData &lt; (pucPayload + ucPayloadLen)) {</div>
<div class="line">  </div>
<div class="line">    printf_P (PSTR(<span class="stringliteral">&quot;%02X &quot;</span>), *pucData++);</div>
<div class="line">  }</div>
<div class="line">  <span class="comment">// show the payload size</span></div>
<div class="line">  printf_P (PSTR(<span class="stringliteral">&quot;&gt; %d\n&quot;</span>), ucPayloadLen + 3);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// queue packet for transfer to the device/sensor</span></div>
<div class="line">  ucStatus = <a class="code" href="a00293.html#gaee368d1d10062ee8ef9db75e1364a2fe">rfSetBackchannelData</a> (usDeviceId, ucPktCount++, usBeaconTime, pucPayload, ucPayloadLen);</div>
<div class="line">  <span class="keywordflow">if</span> (ucStatus == CMD_STATUS_MSG_QUEUED) {</div>
<div class="line">  </div>
<div class="line">    vPrintOk();</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">  </div>
<div class="line">    vPrintError();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// process the &lt;snd&gt; command and parse three parameters. </span></div>
<div class="line"><span class="comment">//  syntax: snd [usDeviceId] [payload]</span></div>
<div class="line"><span class="comment">//    when usDeviceId=x the playload is send</span></div>
<div class="line"><span class="comment">//    to all devices currently bound to the hub</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vDoSndCommand (<span class="keywordtype">char</span> * cCmd, uint8_t ucLen) {</div>
<div class="line">  uint16_t usDeviceId = 0;</div>
<div class="line">  <span class="keywordtype">bool</span>  sndToAll = <span class="keyword">false</span>;</div>
<div class="line">  uint8_t  * pucPayload = NULL;</div>
<div class="line">  uint8_t  ucPayloadLen = 0;</div>
<div class="line">  uint8_t ucIndex;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> (ucLen &gt; 4) {</div>
<div class="line">    <span class="comment">// query for first number - cCmd+4 points to first character of the number</span></div>
<div class="line">    <span class="keywordflow">if</span> (cCmd[4] == <span class="charliteral">&#39;x&#39;</span>) {</div>
<div class="line">    </div>
<div class="line">      sndToAll = <span class="keyword">true</span>;</div>
<div class="line">    } </div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">    </div>
<div class="line">      usDeviceId = atoi (&amp;cCmd[4]);</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// look for additional data, and set the pointer if found</span></div>
<div class="line">    <span class="keywordflow">for</span> (ucIndex = 4; ucIndex &lt; ucLen; ucIndex++) {</div>
<div class="line">    </div>
<div class="line">      <span class="keywordflow">if</span> ((cCmd[ucIndex] == <span class="charliteral">&#39; &#39;</span>) &amp;&amp; (ucLen &gt; ucIndex + 1)) {</div>
<div class="line">      </div>
<div class="line">        pucPayload = (uint8_t *) &amp;cCmd[ucIndex + 1];  <span class="comment">// cut the leading space</span></div>
<div class="line">        ucPayloadLen = ucLen - (ucIndex + 2);  <span class="comment">// cut the trailing \r</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">if</span> (sndToAll == <span class="keyword">false</span>) {  <span class="comment">// send data to one sensor</span></div>
<div class="line">  </div>
<div class="line">    vSendBackData (usDeviceId, pucPayload, ucPayloadLen);</div>
<div class="line">  } </div>
<div class="line">  <span class="keywordflow">else</span> {        <span class="comment">// send data to all sensors</span></div>
<div class="line">    uint16_t usDeviceId;</div>
<div class="line">    uint16_t usMaximumDeviceId = <a class="code" href="a00293.html#gafca611de2af26b00c78adf47e4460781">rfGetMaximumDeviceId</a>();</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (usDeviceId = 0; usDeviceId &lt;= usMaximumDeviceId; usDeviceId++) {</div>
<div class="line">      uint8_t ucStatus;</div>
<div class="line">      </div>
<div class="line">      ucStatus = <a class="code" href="a00293.html#ga270559d73bc5379a0fe9a7d72b88af98">rfGetSensorMID</a> (usDeviceId, NULL);</div>
<div class="line">      </div>
<div class="line">      <span class="keywordflow">if</span> (ucStatus) {</div>
<div class="line">      </div>
<div class="line">        vSendBackData (usDeviceId, pucPayload, ucPayloadLen);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// process the &lt;cnf&gt; command and parse two parameters. </span></div>
<div class="line"><span class="comment">//  syntax: cnf [ucPnCode] [ucChannel]</span></div>
<div class="line"><span class="comment">//    calls rfConfigureNetwork</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vDoCnfCommand (<span class="keywordtype">char</span> * cCmd, uint8_t ucLen) {</div>
<div class="line">  uint8_t ucPnCode = 1;  <span class="comment">// set the default values</span></div>
<div class="line">  uint8_t ucChannel = 1;</div>
<div class="line">  uint8_t ucStatus;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (ucLen &gt; 4) {</div>
<div class="line">    uint8_t ucIndex;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// query for first number - cCmd+4 points to first character of the number</span></div>
<div class="line">    ucPnCode = atoi (&amp;cCmd[4]);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (ucIndex = 4; ucIndex &lt; ucLen; ucIndex++) {</div>
<div class="line">    </div>
<div class="line">      <span class="keywordflow">if</span> (cCmd[ucIndex] == <span class="charliteral">&#39; &#39;</span>) {</div>
<div class="line">      </div>
<div class="line">        ucChannel = atoi (&amp;cCmd[ucIndex]);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// this code changes the mid value of the hub</span></div>
<div class="line">  <span class="comment">//U32 nMid = 0x6035f934;//34 f9 35 60</span></div>
<div class="line">  <span class="comment">//uint8_t ucStatus = rfConfigureNetwork (ucPnCode, ucChannel, &amp;nMid);</span></div>
<div class="line">   </div>
<div class="line">  <span class="comment">// mid value should stay as it is given in the iDwaRF module</span></div>
<div class="line">  ucStatus = <a name="a26"></a><a class="code" href="a00293.html#ga18df5b22a1bdf1437f9cd562e2614333">rfConfigureNetwork</a> (ucPnCode, ucChannel, NULL);</div>
<div class="line">  <span class="keywordflow">if</span> (ucStatus == 0) {</div>
<div class="line">  </div>
<div class="line">    vPrintOk();</div>
<div class="line">    printf_P (PSTR (<span class="stringliteral">&quot;Pn=%d - Ch=%d\n&quot;</span>), ucPnCode, ucChannel);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> {</div>
<div class="line">  </div>
<div class="line">    vPrintError();</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// process the &lt;tim&gt; command and parse one parameter. </span></div>
<div class="line"><span class="comment">//  syntax: tim [beacontime]</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vDoTimCommand (<span class="keywordtype">char</span> * cCmd, uint8_t ucLen) {</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (ucLen &gt; 4) {</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// query for first number - cCmd+4 points to first character of the number</span></div>
<div class="line">    usBeaconTime = atoi (&amp;cCmd[4]);</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  vPrintBeaconTime();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// -----------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment">// process the &lt;del&gt; command and parse one parameter. </span></div>
<div class="line"><span class="comment">//  syntax: del [usDeviceId]</span></div>
<div class="line"><span class="comment">//    removes the sensor &lt;devideId&gt; from the list of known sensors.</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="keywordtype">void</span> </div>
<div class="line">vDoDelCommand (<span class="keywordtype">char</span> * cCmd, uint8_t ucLen) {</div>
<div class="line">  uint16_t usDeviceId = 0;  <span class="comment">// set the default values</span></div>
<div class="line">  uint8_t ucStatus;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (ucLen &gt; 4) {</div>
<div class="line">  </div>
<div class="line">    <span class="comment">// query for first number - cCmd+4 points to first character of the number</span></div>
<div class="line">    usDeviceId = atoi (&amp;cCmd[4]);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  ucStatus = <a class="code" href="a00293.html#ga94f65ad2454ca5084807877fe5cb0259">rfDeleteSensor</a> (usDeviceId);</div>
<div class="line">  vPrintOk();</div>
<div class="line">  printf_P (PSTR(<span class="stringliteral">&quot;0x%02X\n&quot;</span>), ucStatus);</div>
<div class="line">}</div>
<div class="line"><span class="comment">/* ========================================================================== */</span></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Généré le Vendredi 21 Mars 2014 21:47:51 pour AvrIO par
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
